---
title: "HW4Selezneva"
output: html_document
date: "2024-04-03"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Импорт библиотек

```{r}
library(ggplot2)
library(tidyverse)
library(car)
library(tibble)
```

## Задание 1 (2 балла)

Рассмотрите следующую статистическую гипотезу.

-   Проводят некоторое исследование пациентов с артериальной гипертензией. Предположим, что внедрение нового препарата в среднем лучше снижает их давление по сравнению со стандартной терапией.

-   Задайте `seed` для воспроизводимости результатов (функция `set.seed()`). Задайте размер выборки `sample_size <- 30`. Задайте значение среднего артериального давления до приема нового препарата и после.

```{r}
# Установка seed для воспроизводимости результатов 
set.seed(42)

# Задаем размер выборки
sample_size <- 30

# Среднее артериальное давление до и после приема препарата
mean_pressure_before <- 140
mean_pressure_after <- 130

# Стандартное отклонение до и после приема препарата
sd_before <- 10
sd_after <- 8

# Генерация выборок
pressure_before <- rnorm(sample_size, mean_pressure_before, sd_before)
pressure_after <- rnorm(sample_size, mean_pressure_after, sd_after)

```

Затем

-   Сформулируйте нулевую и альтернативную гипотезы. Текст задания: Предположим, что внедрение нового препарата в среднем *лучше* снижает их давление по сравнению со стандартной терапией.

    -   **Исследовательская гипотеза HR**: Предполагает, что новый препарат в среднем лучше снижает артериальное давление по сравнению со стандартной терапией, то есть среднее артериальное давление (CАД) на новом препарате меньше, чем САД на стандартной терапии mu_after \< mu_before

    -   **H0** : Среднее артериальное давление (САД) после применения нового препарата **не меньше**, чем САД после стандартной терапии. mu_after ​\>= mu_before

    -   **HA** : Среднее артериальное давление (САД) после применения нового препарата **меньше**, чем САД после стандартной терапии. mu_after \< mu_before. alternative = "less"

-   Определите уровень значимости.

    alpha = 0.05

-   Выберите статистический тест для проверки гипотезы и аргументируйте свой выбор.

    Следует сначала выполнить тест на нормальность распределения. Пример: тест Шапиро-Уилка и QQ-plot

```{r}
# Тест Шапиро-Уилка для проверки нормальности распределения
shapiro_test_before <- shapiro.test(pressure_before)
shapiro_test_after <- shapiro.test(pressure_after)

# Вывод результатов теста Шапиро-Уилка
cat("Тест Шапиро-Уилка для выборки до введения препарата:\n")
print(shapiro_test_before)
cat("\nТест Шапиро-Уилка для выборки после введения препарата:\n")
print(shapiro_test_after)

# Построение QQ-plot для обеих выборок
par(mfrow = c(1, 2)) # Установка параметра для вывода двух графиков рядом
qqnorm(pressure_before, main = "QQ-plot до введения препарата")
qqline(pressure_before, col = "red")
qqnorm(pressure_after, main = "QQ-plot после введения препарата")
qqline(pressure_after, col = "red")
```

Данные в обеих выборках распределены нормально, так как p-value \> 0.05 , значит мы не отвергаем H0(данные распределены нормально). Это параметрическое распределение, соотвественно нам нужен параметрический тест. Выборки являются зависимыми, так как измерения производились до приема нового препарата и после приема нового препарата ( Если бы мы построили экперимент по-другому и часть пациентов осталась бы на старом препарате а часть перевели на новый препарат, то тогда это были бы независимые выборки)

Значит при нормальности распределений и зависимых выборках нам подходит парный t-тест для связанных выборок.

-   Определите наблюдаемое значение статистики, а также критическое значение статистики.

```{r}
# Проведение парного t-теста с альтернативной гипотезой "less"
test_results <- t.test(pressure_after, pressure_before, paired = TRUE, alternative = "less")

# Вывод полных результатов t-теста
print(test_results)
```

-   Интепретация результатов теста

    -   **t-значение**: -3.8792. Отрицательное значение t-статистики указывает на то, что среднее давление после применения препарата действительно меньше, чем давление до его применения(на стандартной терапии), что соответствует ожидаемому направлению эффекта.

    -   **Степени свободы (df)**: 29. Это значение соответствует размеру выборки минус один (sample_size - 1).

    -   **p-значение**: 0.0002774. Показывает, что различие между средними давлениями до и после введения препарата является статистически значимым. Так как p-значение значительно меньше уровня значимости 0.05, мы можем отклонить нулевую гипотезу в пользу альтернативной. (см HA)

    -   **95% доверительный интервал для средней разницы**: (-∞, -6.553438). Этот интервал не включает 0, что подтверждает статистическую значимость разницы. Он говорит о том, что истинная средняя разница в давлении с 95% вероятностью не выше -6.553438 единиц, подчеркивая значимое уменьшение давления благодаря препарату.

    -   **Средняя разница**: -11.66114. Это значение подтверждает, что в среднем давление после применения препарата снизилось на 11.66114 единиц по сравнению с давлением до его применения.

```{r}
# Определение критического значения для одностороннего теста
alpha <- 0.05
df <- 29
critical_value <- qt(alpha, df, lower.tail = TRUE)
critical_value

```

-   Критическое значение t-статистики, равное -1.699127, используется для определения статистической значимости различий между сравниваемыми группами в контексте одностороннего t-теста с альтернативной гипотезой, указывающей на уменьшение (в моем случае, alternative = "less"). Это значение относится к порогу, ниже которого различия между группами считаются статистически значимыми на уровне значимости 0.05.

Результаты:

-   **Наблюдаемое t-значение**: -3.8792

-   **Критическое t-значение**: -1.699127

Так как наблюдаемое t-значение (-3.8792) меньше критического значения (-1.699127) и находится в левом хвосте распределения t-статистики, это указывает на то, что различие между средним артериальным давлением до и после введения нового препарата статистически значимо на выбранном уровне значимости α = 0.05. Мы находимся в зоне отклонения нулевой гипотезы в пользу альтернативной, что подтверждает эффективность нового препарата в снижении артериального давления по сравнению со стандартной терапией.

**Интерпретация результатов**

Результаты дают основания отвергнуть нулевую гипотезу о том, что новый препарат не эффективнее стандартной терапии в снижении артериального давления. На основании p-значения (0.0002774) и сравнения наблюдаемого t-значения с критическим, можно сделать вывод о статистически значимом снижении артериального давления у пациентов после применения нового препарата.

Это означает, что исследование дает достаточные доказательства в пользу эффективности нового препарата в сравнении со стандартной терапией, подтверждая исходную исследовательскую гипотезу об улучшении состояния пациентов с артериальной гипертензией.

## Задание 2 (2 балла)

Рассмотрите следующую статистическую гипотезу.

-   Существует некоторая связь между курением и развитием рака легких. Пусть у курящих людей вероятность заболеть раком легких составляет 0.8, а у некурящих — 0.2

-   Рассмотрите два случая: для выборки `sample_size1 <- 100` и выборки `sample_size2 <- 30`. Сгенерируйте данные по курению с помощью функции `rep()`, пусть отношение числа курящих к некурящим в каждой выборке составляет 1:1.

```{r}
# Задаем размеры выборок
sample_size1 <- 100
sample_size2 <- 30

# Генерация данных о курении
# Половина курящие, половина некурящие для каждой выборки
smoking_status1 <- rep(c(1, 0), each = sample_size1 / 2)
smoking_status2 <- rep(c(1, 0), each = sample_size2 / 2)

# Устанавливаем seed перед генерацией данных о заболеваемости раком легких для первой выборки
set.seed(13)
# Генерируем данные о заболеваемости раком легких для первой выборки, в зависимости от smoking_status 
lung_cancer1 <- ifelse(smoking_status1 == 1, rbinom(length(smoking_status1), 1, 0.8), rbinom(length(smoking_status1), 1, 0.2))

# Установим seed для второй выборки 
set.seed(42)
# Генерируем данные о заболеваемости раком легких для второй выборки, в зависимости от smoking_status
lung_cancer2 <- ifelse(smoking_status2 == 1, rbinom(length(smoking_status2), 1, 0.8), rbinom(length(smoking_status2), 1, 0.2))

# Создаем датафреймы для каждой выборки
sample_100 <- data.frame(sample_id = rep("sample1", length(smoking_status1)),
                  smoking_status = smoking_status1,
                  lung_cancer = lung_cancer1)

sample_30 <- data.frame(sample_id = rep("sample2", length(smoking_status2)),
                  smoking_status = smoking_status2,
                  lung_cancer = lung_cancer2)


```

-   Сформулируйте нулевую и альтернативную гипотезы.

    -   **Нулевая гипотеза (H0):** Вероятность развития рака легких в группах курящих и не курящих одинакова.

    -   **Альтернативная гипотеза (H1):** Вероятность развития рака легких в группе курящих статистически значимо выше чем в группе некурящих.

-   Зададим уровень значимости alpha = 0.05

-   Визуализируем данные

```{r}
# Подготовка данных для визуализации для sample_100
table_100 <- table(sample_100$smoking_status, sample_100$lung_cancer)
rownames(table_100) <- c("Некурящие", "Курящие")
colnames(table_100) <- c("Здоровы", "Больны раком легких")

# Визуализация для sample_100
barplot(table_100, beside = TRUE, 
        main = "Выборка 100: Распределение заболеваемости раком легких",
        xlab = "Статус курения", ylab = "Количество",
        col = c("lightblue", "salmon"), legend = rownames(table_100))

# Подготовка данных для визуализации для sample_30
table_30 <- table(sample_30$smoking_status, sample_30$lung_cancer)
rownames(table_30) <- c("Некурящие", "Курящие")
colnames(table_30) <- c("Здоровы", "Больны раком легких")

# Визуализация для sample_30
barplot(table_30, beside = TRUE, 
        main = "Выборка 30: Распределение заболеваемости раком легких",
        xlab = "Статус курения", ylab = "Количество",
        col = c("lightgreen", "orange"), legend = rownames(table_30))

```

-   Выбран точный тест Фишера исходя из

    -   обе переменные категориальные

    -   наблюдения независимы

    -   в выборке с размером 30 здоровых курящих меньше 5 наблюдений как и в случае некурящих больных

```{r}
# Для выборки 100
fisher.test_100 <- fisher.test(table(sample_100$smoking_status, sample_100$lung_cancer), alternative = "greater")

# Вывод результатов для выборки 100
print("Результаты точного теста Фишера для выборки 100 с односторонней альтернативой:")
print(fisher.test_100)

# Для выборки 30
fisher.test_30 <- fisher.test(table(sample_30$smoking_status, sample_30$lung_cancer), alternative = "greater")

# Вывод результатов для выборки 30
print("Результаты точного теста Фишера для выборки 30 с односторонней альтернативой:")
print(fisher.test_30)

```

-   Определите наблюдаемое значение статистики, а также критическое значение статистики.

    Для точного теста Фишера p-value расчитываются на основе таблиц сопряженности, поэтому не применимо значение статистики и критическое значение статистики.

-   Интерпретация результатов

    Для sample_100

    -   p-значение 1.304e-08 гораздо меньше стандартного порога значимости (0.05), что указывает на наличие статистически значимого различия в вероятности развития рака легких между курящими и некурящими. Этот результат позволяет отвергнуть нулевую гипотезу в пользу альтернативной.

    -   Odds Raitio 12.54522 Шансы на развитие рака легких у курящих в этой выборке примерно в 12.5 раз выше, чем у некурящих. Доверительный интервал для шансового отношения начинается от 5.222 и не имеет верхней границы, что указывает на значительно повышенный риск развития рака легких среди курящих.

    Для sample_30

    -   p-значение 0.00461 также меньше 0.05, указывает на статистически значимое увеличение вероятности развития рака легких у курящих по сравнению с некурящими и в этой меньшей выборке.

    -   Odds Ratio 9.952827 Шансы на развитие рака легких у курящих в выборке 30 примерно в 10 раз выше, чем у некурящих. Доверительный интервал для шансового отношения начинается от 1.998 и также не имеет верхней границы, подтверждая повышенный риск.

    ## Задание 3 (3 балла)

    Рассмотрите следующую статистическую гипотезу.

-   Применение нового метода лечения синдрома раздраженного кишечника значимо **меняет** уровень болевых симптомов по сравнению с группой, прошедшей лечение диетотерапией.

-   Исследователь избегает любых допущений, кроме того, что выборки независимы и имеют одинаковое распределение.

```{r}
# Посеем семя рандома
set.seed(50)
sample_size_ibd <- 50

# Средние и стандартные отклонения для каждой группы
mean_new_method <- 4
sd_new_method <- 2
mean_diet <- 6
sd_diet <- 2

# Генерируем дискретные выборки и ограничиваем выборки от 0-10, чтобы смоделировать уровни боли 
new_method_group <- pmin(pmax(round(rnorm(sample_size_ibd, mean_new_method, sd_new_method)), 0), 10)
diet_group <- pmin(pmax(round(rnorm(sample_size_ibd, mean_diet, sd_diet)), 0), 10)

# Объединяем в один датасет
treatment <- data.frame(New_method = new_method_group,
                            Diet = diet_group)
# Смотрим на результат
head(treatment)


```

-   Сформулируйте нулевую и альтернативную гипотезы.

    -   H0: Нет статистически значимых различий между эффективностью лечения новым методом и диетотерапией.

    -   H1: Есть статистически значимые различия между эффективностью лечения новым методом и диетотерапией.

-   Определите уровень значимости.

    Уровень значимости 0.05

-   Визуализация данных

```{r}
# Подготовка данных
treatment_long <- pivot_longer(treatment, cols = c(New_method, Diet), names_to = "Treatment", values_to = "Pain_Level")

# Визуализация данных с помощью гистограммы
ggplot(treatment_long, aes(x = Pain_Level, fill = Treatment)) +
  geom_histogram(position = "identity", alpha = 0.5, binwidth = 1) +
  scale_fill_manual(values = c("New_method" = "blue", "Diet" = "red")) +
  labs(title = "Pain Level Distribution by Treatment Method", x = "Pain Level", y = "Count") +
  facet_wrap(~Treatment) +
  theme_minimal()
```

-   Исследуем распределения на нормальность

```{r}
# Тест Шапиро-Уилка на нормальность для нового метода лечения
shapiro_test_new_method <- shapiro.test(new_method_group)

# Тест Шапиро-Уилка на нормальность для диетотерапии
shapiro_test_diet <- shapiro.test(diet_group)

# Вывод результатов
shapiro_test_new_method
shapiro_test_diet

```

Для группы нового метода лечения: P-значение = 0.03992 Так как p-значение меньше 0.05, мы отвергаем нулевую гипотезу о том, что данные распределены нормально. Это означает, что распределение уровней боли в группе нового метода лечения статистически значимо отличается от нормального распределения.

Для группы диетотерапии: P-значение = 0.3352 В этом случае p-значение больше 0.05, что означает, что мы не имеем достаточных оснований отвергнуть нулевую гипотезу о нормальности распределения данных. Другими словами, данные о болевых ощущениях в группе диетотерапии не показывают статистически значимых отклонений от нормального распределения.

-   Выберите статистический тест для проверки гипотезы и аргументируйте свой выбор.

    Выбран тест Манна-Уитни:

    -   Так как одна из групп не следует нормальному распределению, тест Манна-Уитни непараметрический
    -   У нас имеются две независимые выборки
    -   Вместо сравнения средних значений или медиан напрямую, тест Манна-Уитни сравнивает ранги (порядковые номера) наблюдений в объединенной выборке.
    -   Благодаря своей ранговой природе, тест Манна-Уитни более устойчив к наличию выбросов по сравнению с параметрическими тестами

```{r}
# Проведение теста Манна-Уитни
test_result <- wilcox.test(new_method_group, diet_group)

# Вывод результатов теста
print(test_result)

```

-   Определите наблюдаемое значение статистики, а также критическое значение статистики.

    Существуют таблицы критических значений для теста Мана-Уитни , но они ограничиваются выборками в 20-30 наблюдений. Критические значения можно также посчитать по формуле

    ```{r}
    # Параметры выборок
    n1 <- 50
    n2 <- 50

    # Расчет среднего значения и стандартного отклонения для U-статистики
    mu_U <- n1 * n2 / 2
    sigma_U <- sqrt(n1 * n2 * (n1 + n2 + 1) / 12)

    # Критические значения Z для двустороннего теста при уровне значимости 0.05
    Z_critical <- 1.96

    # Расчет критических значений U
    U_critical_lower <- mu_U - Z_critical * sigma_U
    U_critical_upper <- mu_U + Z_critical * sigma_U

    # Вывод критических значений U
    U_critical_lower
    U_critical_upper
    ```

-   Оцените и прокомментируйте статистическую значимость.

    -   Значение статистики W = 577.5

    -   P-значение = 2.899e-06

        P-value 2.899e-06 значительно меньше порога значисомти alpha = 0.05. Это означает, что вероятность получить такие или более экстремальные различия между двумя группами, если бы на самом деле никаких различий между ними не было (то есть, если бы нулевая гипотеза была верна), крайне мала.

        Нулевая гипотеза отвергается. Это указывает на наличие статистически значимых различий между группами, получившими новое лечение и диетотерапию, в отношении уровня боли. Следовательно, можно сделать вывод о том, что эффективность лечения новым методом и диетотерапией статистически значимо различается.

-   Полученное значение W = 577.5 находится вне диапазона критических значений статистики, (меньше, чем нижнее критическое значение 965.69), что указывает на наличие статистически значимых различий между двумя сравниваемыми группами.

## Задание 4 (4 балла)

Рассмотрите следующую гипотезу.

Проводится исследование, в котором исследуются три противоопухолевые препарата A, B плацебо (0) на трех группах мышей. В каждой из трех групп по 10 мышей.  Оценивается размер опухоли у мыши.

-   Сгенерируйте датасет следующим образом:

```{r}
set.seed(123)

tumor <- tibble(
  therapy = c(rep("0", 10), rep("A", 10), rep("B", 10)),
  value = c(rep(3213, 10), rep(2687, 10), rep(2423, 10))
) %>%
  mutate(therapy = factor(therapy, levels = c("0", "A", "B")))

tumor$value <- tumor$value + rnorm(30, 0, 760)

```

-   Постройте на одном графике три ящика с усами для наглядности.

```{r}
# Построение ящика с усами
ggplot(tumor, aes(x = therapy, y = value, fill = therapy)) +
  geom_boxplot() +
  scale_fill_manual(values=c("0"="blue", "A"="red", "B"="green")) +
  labs(title = "Размер опухоли по группам терапии", x = "Группа терапии", y = "Размер опухоли") +
  theme_minimal()
```

-   Проведите дисперсионный анализ, чтобы выяснить, есть ли разница между размером опухоли во всех группах. 

    Чтобы приступить к дисперсионному анализу, сначала нужно выполнить тесты на предпосылки к нормальности и гомогенности дисперсий.

```{r}

# Проверка на нормальность для каждой группы
shapiro.test(tumor$value[tumor$therapy == "0"])
shapiro.test(tumor$value[tumor$therapy == "A"])
shapiro.test(tumor$value[tumor$therapy == "B"])

# Проверка на гомоскедастичность
# Тест Левена предпочтителен, так как он менее чувствителен к отклонениям от нормальности
leveneTest(value ~ therapy, data = tumor)


```

Так как p-values (0.389, 0.7018, 0.5137) теста Шапиро-Уилка для всех групп \> 0.05 делаем вывод , что данные распределены нормально во всех трех выборках.

Тест Левена показывает p-значение — 0.9995. Это p-значение выше общепринятого порога статистической значимости (0.05), что указывает на отсутствие статистически значимых различий в дисперсиях размеров опухоли между группами.

Таким образом, можно сделать вывод, что предпосылка о гомоскедастичности (однородности дисперсий) для проведения однофакторного дисперсионного анализа (ANOVA) выполняется.

```{r}
# Проведение ANOVA
anova_model <- aov(value ~ therapy, data = tumor)
summary(anova_model)

```

-   Интерпретация

    P-значение равно 0.00539, что значительно меньше стандартного порога в 0.05. Это означает, что мы отвергаем нулевую гипотезу о том, что нет различий в средних размерах опухолей между группами терапии. Следовательно, имеются статистически значимые различия между хотя бы двумя группами.

-   С помощью функции\*\* `TukeyHSD()` \*\*проведите попарные сравнения, используя критерий Тьюки.

```{r}
# Проведение теста Тьюки
tukey_results <- TukeyHSD(anova_model)

# Вывод результатов теста
print(tukey_results)


```

### Сравнения и результаты:

1.  **A и 0 :**

    -   **Разница в средних:** -424.16

    -   **95% ДИ (доверительный интервал):** от -1246.07 до 397.74

    -   **p-значение:** 0.4186

2.  **B и 0 :**

    -   **Разница в средних:** -1169.38

    -   **95% ДИ:** от -1991.29 до -347.47

    -   **p-значение:** 0.0042

3.  **B и A :**

    -   **Разница в средних:** -745.22

    -   **95% ДИ:** от -1567.12 до 76.69

    -   **p-значение:** 0.0811

### Интерпретация результатов:

-   **Препарат A и Плацебо:** Различие между группой, получавшей препарат A, и плацебо не является статистически значимым (p = 0.4186), что указывает на отсутствие достаточных доказательств в пользу различия между этими группами.

-   **Препарат B и Плацебо:** Различие между группой, получавшей препарат B, и плацебо является статистически значимым (p = 0.0042). Это говорит о том, что препарат B статистически значимо уменьшил размер опухоли по сравнению с плацебо.

-   **Препарат B и Препарат A:** Хотя разница в средних показывает, что препарат B может быть более эффективен, чем препарат A, данное различие не достигает статистической значимости (p = 0.0811), что означает, что не хватает статистических доказательств для подтверждения различия между эффективностью этих двух препаратов.

### Заключение:

На основе этих результатов можно сделать вывод, что препарат B значимо эффективнее плацебо в уменьшении размера опухоли. Однако нет достаточных доказательств, подтверждающих различие в эффективности между препаратами A и B, а также между препаратом A и плацебо.
